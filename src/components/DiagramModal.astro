---
---
<dialog id="diagram-modal" class="diagram-modal">
  <div class="modal-wrapper">
    <button class="modal-close" aria-label="Close modal">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
    
    <div class="modal-card">
      <div class="zoom-controls">
        <button id="zoom-in" class="control-btn" aria-label="Zoom In" title="Zoom In (+)">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </button>
        <button id="zoom-reset" class="control-btn" aria-label="Reset Zoom" title="Reset (R)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
        </button>
        <button id="zoom-out" class="control-btn" aria-label="Zoom Out" title="Zoom Out (-)">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </button>
      </div>

      <div class="diagram-viewport" id="diagram-viewport">
        <div class="diagram-canvas" id="modal-content-target"></div>
      </div>
    </div>
  </div>
</dialog>

<script>
  const modal = document.getElementById('diagram-modal') as HTMLDialogElement;
  const target = document.getElementById('modal-content-target') as HTMLElement;
  const viewport = document.getElementById('diagram-viewport') as HTMLElement;
  const closeBtn = document.querySelector('.modal-close');
  
  // Controls
  const btnIn = document.getElementById('zoom-in');
  const btnOut = document.getElementById('zoom-out');
  const btnReset = document.getElementById('zoom-reset');

  // State
  let scale = 1;
  let pointX = 0;
  let pointY = 0;
  let isPanning = false;
  let startX = 0;
  let startY = 0;

  function updateTransform() {
    if (target) {
      target.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
    }
  }

  function resetZoom() {
    scale = 1;
    pointX = 0;
    pointY = 0;
    updateTransform();
  }

  function zoom(delta: number) {
    const newScale = Math.max(0.1, Math.min(5, scale + delta));
    scale = newScale;
    updateTransform();
  }

  // Event Handlers for Panning
  if (viewport) {
    viewport.addEventListener('mousedown', (e) => {
      e.preventDefault(); // Prevent text selection
      isPanning = true;
      startX = e.clientX - pointX;
      startY = e.clientY - pointY;
      viewport.style.cursor = 'grabbing';
    });

    window.addEventListener('mousemove', (e) => {
      if (!isPanning) return;
      e.preventDefault();
      pointX = e.clientX - startX;
      pointY = e.clientY - startY;
      updateTransform();
    });

    window.addEventListener('mouseup', () => {
      isPanning = false;
      if (viewport) viewport.style.cursor = 'grab';
    });

    // Wheel Zoom
    viewport.addEventListener('wheel', (e) => {
      e.preventDefault();
      const ZOOM_SPEED = 0.001;
      const newScale = Math.max(0.1, Math.min(5, scale - e.deltaY * ZOOM_SPEED));
      
      // Simple zoom to center for robustness, or we could implement pointer-based zoom
      // For now, simple scale change is much safer to implement without glitches
      scale = newScale;
      updateTransform();
    }, { passive: false });
  }

  // Button Listeners
  btnIn?.addEventListener('click', () => zoom(0.2));
  btnOut?.addEventListener('click', () => zoom(-0.2));
  btnReset?.addEventListener('click', resetZoom);

  if (modal && target && closeBtn) {
    window.openDiagramModal = (contentHtml) => {
      // Clean up SVG
      const temp = document.createElement('div');
      temp.innerHTML = contentHtml;
      const svg = temp.querySelector('svg');
      if (svg) {
        svg.removeAttribute('style');
        svg.removeAttribute('width');
        svg.removeAttribute('height');
        svg.removeAttribute('max-width');
        svg.classList.add('modal-svg');
      }

      target.innerHTML = temp.innerHTML;
      resetZoom(); // Reset state on open
      modal.showModal();
      document.body.style.overflow = 'hidden';
    };

    const close = () => {
      modal.close();
      document.body.style.overflow = '';
      target.innerHTML = '';
      resetZoom();
    };

    closeBtn.addEventListener('click', close);
    modal.addEventListener('click', (e) => {
      // Close if clicked on backdrop (wrapper), but not on the card itself
      if (e.target === document.querySelector('.modal-wrapper')) close();
    });
    modal.addEventListener('cancel', () => {
      document.body.style.overflow = '';
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (!modal.open) return;
      if (e.key === '+' || e.key === '=') zoom(0.1);
      if (e.key === '-' || e.key === '_') zoom(-0.1);
      if (e.key === 'r' || e.key === 'R') resetZoom();
      if (e.key === '0') resetZoom();
    });
  }

  declare global {
    interface Window {
      openDiagramModal: (html: string) => void; 
    }
  }
</script>

<style>
  .diagram-modal {
    padding: 0;
    border: none;
    background: transparent;
    max-width: 100vw;
    max-height: 100vh;
    width: 100%;
    height: 100%;
    backdrop-filter: blur(8px);
  }

  .diagram-modal::backdrop {
    background: rgba(0, 0, 0, 0.85);
  }

  .modal-wrapper {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    padding: 20px; /* Reduced padding to give more space to card */
  }

  .modal-card {
    position: relative;
    width: 90vw;
    height: 85vh; /* Fixed height for the viewport container */
    border-radius: var(--radius-lg);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    box-shadow: var(--shadow-lg);
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Contains the viewport */
  }

  .zoom-controls {
    position: absolute;
    bottom: 20px;
    right: 20px;
    display: flex;
    gap: 8px;
    z-index: 10;
    background: rgba(0, 0, 0, 0.5);
    padding: 8px;
    border-radius: 8px;
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .control-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid transparent;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 6px;
    display: grid;
    place-items: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .control-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: translateY(-1px);
  }

  .control-btn:active {
    transform: translateY(0);
  }

  .diagram-viewport {
    flex: 1;
    width: 100%;
    height: 100%;
    overflow: hidden;
    cursor: grab;
    background: radial-gradient(circle at center, rgba(255,255,255,0.03) 0%, transparent 100%);
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .diagram-viewport:active {
    cursor: grabbing;
  }

  .diagram-canvas {
    transform-origin: center center;
    transition: transform 0.1s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Smooth zoom, snappy pan */
    /* Ensure content is centered and visible */
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 100%;
    min-height: 100%;
    padding: 40px;
  }

  .modal-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid var(--color-border);
    color: white;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    cursor: pointer;
    z-index: 20; /* Above card */
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    backdrop-filter: blur(4px);
  }

  .modal-close:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: rotate(90deg);
  }

  /* Force SVG styling */
  .diagram-canvas :global(svg) {
    width: auto !important;
    height: auto !important;
    max-width: none !important;
    max-height: none !important;
    min-width: 200px; /* Prevent tiny svgs */
    pointer-events: none; /* Let clicks pass through to viewport for dragging */
  }
</style>